{% extends "calculator/base.html" %}

{% block content %}
<div class="calc-page-container">
    <!-- Left: Calculation Form -->
    <div class="calc-container">
        <h2 class="calc-heading">Maintenance Calculator</h2>

        <!-- User Manual Section -->
        <div class="calc-user-manual">
            <h3>Instructions for Uploading Files</h3>
            <p>Please make sure your Excel file contains the following columns:</p>
            <ul>
                <li><strong>Patent/ Publication Number</strong></li>
                <li><strong>Publication Country</strong></li>
                <li><strong>Priority Date</strong></li>
                <li><strong>File Date</strong></li>
                <li><strong>Publication Date</strong></li>
                <li><strong>Est. Expiration Date</strong></li>
                <li><strong>Number of claims</strong></li>
            </ul>
            <p>The file must be in .xlsx format and should not contain any empty rows or irrelevant data.</p>
        </div>

        <!-- File Upload Form -->
        <form method="post" enctype="multipart/form-data" class="calc-form">
            {% csrf_token %}
            <div class="calc-form-group">
                {{ form.file.label_tag }}
                <label class="calc-custom-file-upload">
                    {{ form.file }}
                    Browse
                </label>
            </div>

            <button type="submit" class="calc-btn">Submit</button>
        </form>
        <!-- Existing error message section -->
        {% if error_message %}
        <div class="alert alert-danger" style="color: red; font-weight: bold; margin-top: 20px;">
            <strong>Error:</strong> {{ error_message }}
        </div>
        {% endif %}

        {% if download_url %}
            <a href="{{ download_url }}" class="calc-btn calc-btn-success">Download File</a>
        {% endif %}
    </div>

    <!-- Right: Fees Dollars Section -->
    <div class="calc-fees-container">
        <h2 class="fees-heading">Available countries and their codes:</h2>

        <div class="dropdown-container">
            <input type="text" id="country-search" class="dropdown-search" placeholder="Search for a country">
            <select id="country-list" class="dropdown-menu" size="10">
                {% for code, data in country_codes_and_names.items %}
                    <option value="{{ code }}">{{ code }}: {{ data.country }} ({{ data.type }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="fees-button-container">
            <!-- Download Button -->
            <a href="{% url 'download_fees' %}" class="btn fees-download-btn" style="max-width: 90%;">Download FeesDollars.xlsx</a>
        </div>

        <!-- Upload Form -->
        <form method="post" action="{% url 'upload_fees' %}" enctype="multipart/form-data" class="fees-upload-form">
            {% csrf_token %}
            <label class="fees-custom-file-upload">
                <input type="file" name="fees_file" accept=".xlsx" required>
            </label>
            <button type="submit" class="btn fees-upload-btn">Upload Updated File</button>
        </form>
    </div>
</div>

<!-- Results Repository Section -->
<div class="calc-results-container">
    <h2 class="calc-results-heading">Maintenance Fee Storage</h2>

    <form id="download-form" method="post" action="{% url 'bulk_download' %}" class="calc-results-form">
        {% csrf_token %}
        <div class="calc-repository-sections">
            <div class="calc-repository-section">
                <!-- Scrollable area for files -->
                <div class="calc-scrollable">
                    <ul class="calc-file-list">
                        {% for file in result_files_calculation %}
                            <li class="calc-file-item" onclick="toggleCheckbox(this)">
                                <label>
                                    <input type="checkbox" name="selected_files" value="{{ file.filename }}" class="calc-file-checkbox">
                                    <span class="calc-file-name">{{ file.filename }}</span>
                                    <span class="calc-file-date">By: {{ file.created_by.username }} on {{ file.created_at|date:"Y-m-d" }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <button type="submit" class="calc-btn">Download Selected Files</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const countrySearch = document.getElementById('country-search');

    function filterOptions() {
        const filter = countrySearch.value.toLowerCase();
        const select = document.getElementById('country-list');
        const options = select.options;

        for (let i = 0; i < options.length; i++) {
            const text = options[i].textContent || options[i].innerText;
            if (text.toLowerCase().includes(filter)) {
                options[i].style.display = '';
            } else {
                options[i].style.display = 'none';
            }
        }
    }

    countrySearch.addEventListener('input', filterOptions);
});
</script>
{% endblock %}
